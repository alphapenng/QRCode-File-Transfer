# 发送端状态流程说明

## TransferState 状态定义

发送端有 10 种状态（定义在 `senderIPCService.js`）：

```javascript
export const TransferState = {
  IDLE: '空闲',                    // 初始状态
  SELECTING: '选择文件中',          // 正在选择文件
  PREPROCESSING: '预处理中',        // 正在预处理（压缩、计算哈希）
  CHUNKING: '分片中',              // 正在创建分片
  GENERATING: '生成二维码中',       // 正在生成二维码
  PLAYING: '播放中',               // 正在播放二维码
  PAUSED: '暂停',                  // 传输已暂停
  COMPLETED: '传输完成',           // 传输成功完成
  ERROR: '传输错误',               // 发生错误
  CANCELLED: '传输取消'            // 用户取消传输
};
```

## 状态流程图

```
用户操作: 选择文件
    ↓
IDLE → SELECTING → IDLE (文件已选择)
    ↓
用户操作: 开始传输
    ↓
PREPROCESSING (预处理文件)
    ↓
CHUNKING (创建分片)
    ↓
GENERATING (生成二维码)
    ↓
IDLE (准备就绪)
    ↓
用户操作: 开始传输
    ↓
PLAYING (播放二维码)
    ├─→ 用户暂停 → PAUSED → 用户继续 → PLAYING
    ├─→ 用户取消 → CANCELLED → 用户重置 → IDLE
    ├─→ 播放完成 → COMPLETED → 用户重置 → IDLE
    └─→ 发生错误 → ERROR → 用户重试 → IDLE
```

## 状态转换详解

### 1. IDLE（空闲）
- **进入**: 应用启动、文件选择完成、准备完成、重置后
- **可操作**: 选择文件、开始传输（需先选择文件）
- **UI**: 显示"开始传输"按钮、二维码占位图标

### 2. SELECTING（选择文件中）
- **进入**: 用户点击"选择文件"
- **自动转换**: 选择完成 → IDLE
- **UI**: 禁用"选择文件"按钮

### 3. PREPROCESSING（预处理中）
- **进入**: 用户点击"开始传输"
- **执行**: 压缩文件、计算SHA256
- **自动转换**: 预处理完成 → CHUNKING
- **UI**: 显示旋转图标、进度条（0-25%）

### 4. CHUNKING（分片中）
- **进入**: 预处理完成
- **执行**: 创建文件头、数据分片、文件尾
- **自动转换**: 分片完成 → GENERATING
- **UI**: 显示旋转图标、进度条（25-50%）

### 5. GENERATING（生成二维码中）
- **进入**: 分片完成
- **执行**: 为每个分片生成二维码
- **自动转换**: 生成完成 → IDLE
- **UI**: 显示旋转图标、进度条（50-75%）

### 6. PLAYING（播放中）
- **进入**: 准备完成后用户点击"开始传输"、从PAUSED继续
- **执行**: 播放二维码序列（5 fps）
- **可操作**: 暂停、取消
- **自动转换**: 播放完成 → COMPLETED
- **UI**: 显示二维码、"暂停"和"取消"按钮、进度条（75-100%）

### 7. PAUSED（暂停）
- **进入**: 用户在PLAYING时点击"暂停"
- **可操作**: 继续、取消
- **UI**: 显示二维码+半透明遮罩、"继续"和"取消"按钮

### 8. COMPLETED（传输完成）
- **进入**: 所有二维码播放完成
- **可操作**: 发送新文件（重置）
- **UI**: 显示成功图标、"发送新文件"按钮

### 9. ERROR（传输错误）
- **进入**: 任何阶段发生错误
- **可操作**: 重试（重置）
- **UI**: 显示错误图标、错误信息、"重试"按钮

### 10. CANCELLED（传输取消）
- **进入**: 用户在PLAYING或PAUSED时点击"取消"
- **可操作**: 发送新文件（重置）
- **UI**: 显示取消图标、"发送新文件"按钮

## UI 组件状态映射

### 按钮状态

| 状态 | 显示按钮 | 是否禁用 |
|------|---------|---------|
| IDLE | "开始传输" | 未选择文件时禁用 |
| SELECTING | "选择文件" | 禁用 |
| PREPROCESSING | "预处理中..." | 禁用 |
| CHUNKING | "分片中..." | 禁用 |
| GENERATING | "生成二维码中..." | 禁用 |
| PLAYING | "暂停" + "取消" | 启用 |
| PAUSED | "继续" + "取消" | 启用 |
| COMPLETED | "发送新文件" | 启用 |
| ERROR | "重试" | 启用 |
| CANCELLED | "发送新文件" | 启用 |

### 进度条显示

| 状态 | 是否显示 | 进度范围 |
|------|---------|---------|
| PREPROCESSING | 是 | 0-25% |
| CHUNKING | 是 | 25-50% |
| GENERATING | 是 | 50-75% |
| PLAYING | 是 | 75-100% |
| PAUSED | 是 | 保持当前 |
| 其他状态 | 否 | - |

### 二维码区域显示

| 状态 | 显示内容 |
|------|---------|
| IDLE | 占位图标 + "二维码将在此显示" |
| SELECTING | 保持当前显示 |
| PREPROCESSING | 旋转图标 + "预处理中..." |
| CHUNKING | 旋转图标 + "分片中..." |
| GENERATING | 旋转图标 + "生成二维码中..." |
| PLAYING | 当前二维码图片 |
| PAUSED | 当前二维码图片 + 半透明遮罩 + "已暂停" |
| COMPLETED | 成功图标 + "传输完成" + 分片数量 |
| ERROR | 错误图标 + "发生错误" + 错误信息 |
| CANCELLED | 取消图标 + "传输已取消" |

## 事件触发

### stateChange 事件
- **触发时机**: 每次状态变化
- **数据**: `{ state: TransferState.XXX }`

### progress 事件
- **触发时机**: PREPROCESSING、CHUNKING、GENERATING、PLAYING
- **数据**: `{ stage, message, progress, current, total }`

### qrcode 事件
- **触发时机**: PLAYING 状态，每次二维码切换
- **数据**: `{ qrCode, index, total }`

### complete 事件
- **触发时机**: PLAYING → COMPLETED

### error 事件
- **触发时机**: 任何状态 → ERROR
- **数据**: `{ error, message }`

## 关键实现要点

1. **状态由服务管理**: UI 不应手动设置状态，只监听 `stateChange` 事件
2. **使用常量**: 所有状态比较使用 `TransferState.XXX`，避免魔法字符串
3. **完整支持**: UI 必须处理所有 10 种状态
4. **自动转换**: 准备阶段（PREPROCESSING → CHUNKING → GENERATING）自动进行
5. **用户确认**: 准备完成后回到 IDLE，需要用户再次点击"开始传输"才进入 PLAYING

## 常见问题

**Q: 为什么准备完成后回到 IDLE 而不是直接 PLAYING？**  
A: 为了给用户确认的机会，避免自动开始播放。用户可以在准备完成后选择何时开始传输。

**Q: 如何区分"准备中"的不同阶段？**  
A: 通过状态徽章显示具体状态（预处理中、分片中、生成二维码中），通过进度条显示进度。

**Q: 取消和错误后如何恢复？**  
A: 两者都提供重置按钮，点击后回到 IDLE 状态，清空所有数据，可以重新开始。

